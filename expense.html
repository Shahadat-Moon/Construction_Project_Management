<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expenses</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>

<body class="bg-slate-100 min-h-screen pb-28">

<!-- HEADER -->
<header class="bg-white shadow sticky top-0 z-10">
  <div class="px-4 py-3 grid grid-cols-3 items-center">
    <button onclick="history.back()" class="text-blue-600 text-sm text-left">
      Back
    </button>

    <h1 class="text-lg font-semibold text-center">Expenses</h1>

    <div class="flex justify-end">
      <img src="logo.jpg" class="h-8" alt="Company Logo">
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="p-4 max-w-3xl mx-auto space-y-6">

  <div id="expenseContainer" class="space-y-6"></div>

  <p id="emptyState" class="hidden text-center text-gray-500 mt-16">
    No expense data for the last 30 days
  </p>

</main>

<!-- ADD BUTTON -->
<a href="expense-add.html"
   class="fixed bottom-24 right-4 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg text-3xl hover:bg-blue-700 transition">
  +
</a>

<!-- BOTTOM NAV -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow">
  <div class="grid grid-cols-5 text-xs text-gray-600">
    <a href="index.html" class="py-3 flex flex-col items-center">ğŸ <span>Home</span></a>
    <a href="income.html" class="py-3 flex flex-col items-center">ğŸ’°<span>Income</span></a>
    <a href="expense.html" class="py-3 flex flex-col items-center text-blue-600 font-medium">ğŸ’¸<span>Expense</span></a>
    <a href="projects.html" class="py-3 flex flex-col items-center">ğŸ—ï¸<span>Project</span></a>
    <a href="reports.html" class="py-3 flex flex-col items-center">ğŸ“Š<span>Report</span></a>
  </div>
</nav>

<!-- SCRIPT -->
<script>
  const supabase = window.supabase.createClient(
    'https://sbqyxvxpeqipcuavryhb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNicXl4dnhwZXFpcGN1YXZyeWhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNTk0NjcsImV4cCI6MjA4NDczNTQ2N30.XWbqg5fwC3TDFt-G79H-SGg-9WMdV08qkZ6OzdPK8f8'
  )

  function last30DaysDate() {
    const d = new Date()
    d.setDate(d.getDate() - 30)
    return d.toISOString().split('T')[0]
  }

  async function loadExpenses() {

    // Fetch expenses (last 30 days, latest first)
    const { data: expenses, error } = await supabase
      .from('expense')
      .select('*')
      .gte('date', last30DaysDate())
      .order('date', { ascending: false })

    if (error) {
      console.error(error)
      return
    }

    const container = document.getElementById('expenseContainer')
    const empty = document.getElementById('emptyState')
    container.innerHTML = ''

    if (!expenses || expenses.length === 0) {
      empty.classList.remove('hidden')
      return
    }

    // Fetch project names
    const projectIds = [...new Set(expenses.map(e => e.project_id))]
    const { data: projects } = await supabase
      .from('projects')
      .select('id, name')
      .in('id', projectIds)

    const projectMap = {}
    projects?.forEach(p => projectMap[p.id] = p.name)

    // Group expenses by project
    const grouped = {}
    expenses.forEach(e => {
      if (!grouped[e.project_id]) grouped[e.project_id] = []
      grouped[e.project_id].push(e)
    })

    Object.keys(grouped).forEach(projectId => {
      const card = document.createElement('div')
      card.className = 'bg-white rounded-2xl shadow overflow-hidden'

      const rows = grouped[projectId].map(e => `
        <tr class="border-b last:border-none">
          <td class="py-2 text-green-500">${new Date(e.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</td>
          <td class="py-2">${e.type}</td>
          <td class="py-2 text-red-600 font-medium">à§³ ${e.amount}</td>
          <td class="py-2 text-gray-500">${e.notes || '-'}</td>
        </tr>
      `).join('')

      card.innerHTML = `
        <div class="bg-slate-700 text-white px-4 py-3">
          <p class="font-semibold">${projectMap[projectId] || projectId}</p>
          <p class="text-xs text-slate-200">Project ID: ${projectId}</p>
        </div>

        <div class="p-4 overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-2">Date</th>
                <th class="pb-2">Type</th>
                <th class="pb-2">Amount</th>
                <th class="pb-2">Notes</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        </div>
      `

      container.appendChild(card)
    })
  }

  loadExpenses()
</script>

</body>
</html>
